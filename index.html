<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OkixProMarket</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#1c3684;color:#e4e7eb;overflow-x:hidden;}
        header{display:flex;justify-content:space-between;align-items:center;padding:18px 30px;background:linear-gradient(135deg,#002ef9 0%,#440a51 50%,#ffc400 100%);position:sticky;top:0;z-index:100;box-shadow:0 8px 32px rgba(102,126,234,0.3);backdrop-filter:blur(10px);}
        .nav-left{display:flex;gap:15px;align-items:center;}
        .nav-left a,.nav-right button{color:white;text-decoration:none;font-weight:600;cursor:pointer;background:rgba(255,255,255,0.1);border:none;padding:10px 20px;border-radius:12px;transition:all 0.3s ease;font-size:0.95em;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);}
        .nav-left a:hover,.nav-right button:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
        section{max-width:1300px;margin:auto;padding:40px 20px;display:none;animation:fadeIn 0.4s ease;}
        section.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        .card{background:linear-gradient(145deg,#161b27 0%,#1a1f2e 100%);border-radius:20px;padding:35px;margin-bottom:25px;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid rgba(102,126,234,0.1);transition:all 0.3s ease;}
        .card:hover{box-shadow:0 15px 50px rgba(102,126,234,0.2);transform:translateY(-2px);}
        .auth-container{max-width:480px;margin:80px auto;}
        .auth-tabs{display:flex;gap:12px;margin-bottom:30px;}
        .auth-tabs button{flex:1;padding:16px;background:rgba(102,126,234,0.1);border:2px solid rgba(102,126,234,0.2);color:#e4e7eb;cursor:pointer;border-radius:12px;font-weight:bold;transition:all 0.3s;font-size:1em;}
        .auth-tabs button.active{background:linear-gradient(135deg,#667eea,#bf1c9b);border-color:#667eea;box-shadow:0 4px 15px rgba(102,126,234,0.4);}
        .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:30px;margin-top:30px;}
        .product{background:linear-gradient(145deg,#1a1f2e 0%,#161b27 100%);border-radius:20px;overflow:hidden;transition:all 0.4s cubic-bezier(0.4,0,0.2,1);border:1px solid rgba(102,126,234,0.1);position:relative;}
        .product:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 60px rgba(102,126,234,0.25);border-color:rgba(102,126,234,0.3);}
        .product img{width:100%;height:240px;object-fit:cover;cursor:pointer;transition:transform 0.4s ease;}
        .product:hover img{transform:scale(1.05);}
        .product-info{padding:20px;}
        .product h3{margin:0 0 12px;font-size:1.25em;color:#f8f9fa;}
        .product p{margin:8px 0;color:#a8b2d1;font-size:0.95em;}
        .product-description{margin:15px 0;color:#cdd6f4;line-height:1.5;font-size:0.95em;max-height:100px;overflow:hidden;}
        .product-actions{display:flex;gap:10px;margin-top:18px;}
        .product-badge{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:6px 14px;border-radius:20px;font-size:0.85em;font-weight:bold;box-shadow:0 4px 12px rgba(102,126,234,0.4);}
        .filters{background:linear-gradient(145deg,#161b27,#1a1f2e);padding:25px;border-radius:16px;margin-bottom:30px;display:flex;gap:15px;flex-wrap:wrap;align-items:center;border:1px solid rgba(102,126,234,0.1);}
        .filters input{flex:1;min-width:200px;margin:0;}
        .filters select{padding:12px 18px;border-radius:10px;border:1px solid rgba(102,126,234,0.2);background:#0a0e1a;color:#e4e7eb;font-size:0.95em;cursor:pointer;transition:all 0.3s;}
        .filters select:focus{border-color:#667eea;outline:none;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
        button{padding:13px 28px;border:none;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);font-weight:bold;cursor:pointer;color:white;transition:all 0.3s ease;font-size:1em;box-shadow:0 4px 15px rgba(102,126,234,0.3);}
        button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.5);}
        button.secondary{background:linear-gradient(135deg,#2d3748,#4a5568);box-shadow:0 4px 15px rgba(0,0,0,0.3);}
        button.danger{background:linear-gradient(135deg,#fc466b,#3f5efb);box-shadow:0 4px 15px rgba(252,70,107,0.3);}
        button:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
        input,textarea{display:block;margin:15px 0;padding:14px 18px;border-radius:12px;border:2px solid rgba(102,126,234,0.2);width:100%;background:#0a0e1a;color:#e4e7eb;font-family:inherit;font-size:1em;transition:all 0.3s;}
        input:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,0.1);}
        input[type="file"]{padding:12px;border-style:dashed;}
        label{display:block;margin-top:20px;margin-bottom:8px;font-weight:600;color:#a8b2d1;font-size:0.95em;}
        .user-info{color:white;font-size:0.9em;background:rgba(255,255,255,0.1);padding:8px 16px;border-radius:10px;backdrop-filter:blur(10px);}
        .empty-state{text-align:center;padding:80px 20px;color:#a8b2d1;}
        .empty-state h2{color:#667eea;font-size:2em;margin-bottom:15px;}
        .info-box{background:rgba(102,126,234,0.15);padding:18px;border-radius:12px;margin:15px 0;font-size:0.95em;border-left:4px solid #667eea;}
        .success-box{background:rgba(52,211,153,0.15);padding:18px;border-radius:12px;margin:15px 0;border-left:4px solid #34d399;}
        .error-box{background:rgba(252,70,107,0.15);padding:18px;border-radius:12px;margin:15px 0;border-left:4px solid #fc466b;}
        .toast{position:fixed;bottom:30px;right:30px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:18px 28px;border-radius:12px;box-shadow:0 8px 30px rgba(102,126,234,0.5);z-index:1001;animation:slideInUp 0.4s ease;font-weight:600;}
        @keyframes slideInUp{from{transform:translateY(100px);opacity:0;}to{transform:translateY(0);opacity:1;}}
        #cropperPreview{max-width:100%;margin-top:15px;border-radius:12px;border:2px solid rgba(102,126,234,0.2);display:none;}
        #lightbox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(10px);}
        #lightbox img{max-width:92%;max-height:92%;border-radius:16px;box-shadow:0 20px 80px rgba(102,126,234,0.4);}
        .spinner{border:4px solid rgba(102,126,234,0.1);border-radius:50%;border-top:4px solid #667eea;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px;}
        .stat-card{background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));padding:25px;border-radius:16px;text-align:center;border:1px solid rgba(102,126,234,0.2);transition:all 0.3s;}
        .stat-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(102,126,234,0.2);}
        .stat-card h3{font-size:2.5em;color:#667eea;margin-bottom:10px;}
        .stat-card p{color:#a8b2d1;font-size:0.95em;}

        /* Styles Likes */
        .like-btn {
            background:none; border:none; font-size:1.5em; cursor:pointer; 
            padding:8px 14px; border-radius:12px; transition:all 0.3s;
        }
        .like-btn:hover { background:rgba(252,70,107,0.2); }
        .like-btn.liked { color:#fc466b; }
        .like-count { font-size:0.8em; margin-left:6px; font-weight:bold; }

        /* Compteur description */
        .char-counter { font-size:0.85em; color:#a8b2d1; text-align:right; margin-top:5px; }
        .char-counter.warning { color:#fc466b; }

        @media(max-width:768px){
            header{flex-direction:column;gap:15px;padding:15px;}
            .nav-left{width:100%;justify-content:center;flex-wrap:wrap;}
            .product-grid{grid-template-columns:1fr;}
            .filters{flex-direction:column;}
            .filters input,.filters select{width:100%;}
            .stats{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>

    <!-- Auth Section -->
    <section id="auth" class="active">
        <div class="auth-container">
            <div class="card">
                <div class="auth-tabs">
                    <button id="tab-login" class="active">Connexion</button>
                    <button id="tab-signup">Inscription</button>
                </div>
                <form id="loginForm">
                    <h2 style="margin-bottom:20px;color:#667eea;">Se connecter</h2>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Mot de passe" required>
                    <button type="submit">Se connecter</button>
                    <div id="loginMessage" style="margin-top:15px;"></div>
                </form>
                <form id="signupForm" style="display:none;">
                    <h2 style="margin-bottom:20px;color:#667eea;">Cr√©er un compte</h2>
                    <input type="email" id="signupEmail" placeholder="Email" required>
                    <input type="password" id="signupPassword" placeholder="Mot de passe (min 6 caract√®res)" required>
                    <input type="password" id="signupConfirm" placeholder="Confirmer le mot de passe" required>
                    <button type="submit">S'inscrire</button>
                    <div id="signupMessage" style="margin-top:15px;"></div>
                </form>
            </div>
        </div>
    </section>

    <header id="mainHeader" style="display:none;">
        <div class="nav-left">
            <a onclick="showSection('home')">üè† Home</a>
            <a onclick="showSection('marketplace')">üõí Market</a>
            <a onclick="showSection('add-product')">‚ûï Add</a>
        </div>
        <div class="nav-right">
            <span class="user-info" id="userEmail"></span>
            <button onclick="logout()">D√©connexion</button>
        </div>
    </header>

    <section id="home">
        <div class="card">
            <h1 style="font-size:2.5em;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">üéâ Bienvenue sur le Market by Okix</h1>
            <p style="margin-top:20px;font-size:1.1em;color:#a8b2d1;">D√©couvre des produits incroyables ou ajoute les tiens !</p>
        </div>
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalProducts">0</h3>
                <p>Produits disponibles</p>
            </div>
            <div class="stat-card">
                <h3 id="myProducts">0</h3>
                <p>Mes annonces</p>
            </div>
        </div>
    </section>

    <section id="marketplace">
        <div class="filters">
            <input type="text" id="searchInput" placeholder="üîç Rechercher un produit..." style="margin:0;">
            <select id="sortSelect">
                <option value="recent">Plus r√©cents</option>
                <option value="price-asc">Prix croissant</option>
                <option value="price-desc">Prix d√©croissant</option>
            </select>
        </div>
        <div class="product-grid" id="products"></div>
    </section>

    <section id="add-product">
        <div class="card">
            <h2 style="color:#667eea;margin-bottom:25px;">Ajouter / Modifier un produit</h2>
            <form id="productForm">
                <input type="hidden" id="editId">
                <label>Titre :</label>
                <input type="text" id="title" placeholder="Ex: iPhone 13 Pro Max" required>

                <label>Description (optionnel) :</label>
                <textarea id="description" rows="4" maxlength="500" placeholder="D√©cris ton produit... (max 500 caract√®res)"></textarea>
                <div class="char-counter" id="charCounter">0 / 90</div>

                <label>Prix (‚Ç¨) :</label>
                <input type="number" id="price" step="0.01" min="0.01" placeholder="Ex: 599.99" required>

                <label>Image :</label>
                <input type="file" id="image" accept="image/*">
                <img id="cropperPreview">

                <label>Contact (Snap, email, t√©l√©phone...) :</label>
                <input type="text" id="contact" placeholder="ex: @mon_snap ou 06 12 34 56 78" required>

                <div style="display:flex;gap:10px;margin-top:25px;">
                    <button type="submit" id="submitBtn" style="flex:1;">Ajouter le produit</button>
                    <button type="button" class="secondary" onclick="cancelEdit()" style="display:none;" id="cancelBtn">Annuler</button>
                </div>
            </form>
        </div>
    </section>

    <div id="lightbox" onclick="hideLightbox()">
        <img id="lightboxImg">
    </div>

    <script>
        const SUPABASE_URL = "https://qsixnrwxsekpjfjvtiuc.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzaXhucnd4c2VrcGpmanZ0aXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5NDQ3MTEsImV4cCI6MjA4MjUyMDcxMX0.qToYIo59aDafT4_7MeaaS77_DsHDt7t5vIzRnAI83UY";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let cropper = null;
        let allProducts = [];

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // === AUTH (inchang√©) ===
        document.getElementById('tab-login').addEventListener('click', () => switchTab('login'));
        document.getElementById('tab-signup').addEventListener('click', () => switchTab('signup'));

        function switchTab(tab) {
            document.querySelectorAll('.auth-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(tab === 'login' ? 'tab-login' : 'tab-signup').classList.add('active');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('loginMessage').innerHTML = '';
            document.getElementById('signupMessage').innerHTML = '';
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (session?.user) {
                currentUser = session.user;
                showApp();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                showAuth();
            }
        });

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session?.user) {
                currentUser = session.user;
                showApp();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'Connexion...';
            messageDiv.innerHTML = '<div class="info-box">‚è≥ Connexion en cours...</div>';

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            btn.disabled = false;
            btn.textContent = 'Se connecter';

            if (error) {
                messageDiv.innerHTML = `<div class="error-box">‚ùå ${error.message}</div>`;
            } else {
                messageDiv.innerHTML = '<div class="success-box">‚úÖ Connexion r√©ussie !</div>';
                showToast('‚úÖ Bienvenue !');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const messageDiv = document.getElementById('signupMessage');
            const btn = e.target.querySelector('button');

            if (password !== confirm) {
                messageDiv.innerHTML = '<div class="error-box">‚ùå Les mots de passe ne correspondent pas !</div>';
                return;
            }
            if (password.length < 6) {
                messageDiv.innerHTML = '<div class="error-box">‚ùå Le mot de passe doit contenir au moins 6 caract√®res !</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Cr√©ation...';
            messageDiv.innerHTML = '<div class="info-box">‚è≥ Cr√©ation du compte...</div>';

            const { error } = await supabase.auth.signUp({ email, password });
            btn.disabled = false;
            btn.textContent = "S'inscrire";

            if (error) {
                messageDiv.innerHTML = `<div class="error-box">‚ùå ${error.message}</div>`;
            } else {
                messageDiv.innerHTML = '<div class="success-box">‚úÖ Compte cr√©√© ! Connecte-toi maintenant.</div>';
                document.getElementById('signupForm').reset();
                showToast('‚úÖ Compte cr√©√© avec succ√®s !');
            }
        });

        async function logout() {
            await supabase.auth.signOut();
            showToast('üëã √Ä bient√¥t !');
        }

        function showAuth() {
            document.getElementById('auth').classList.add('active');
            document.getElementById('mainHeader').style.display = 'none';
            document.querySelectorAll('section:not(#auth)').forEach(s => s.classList.remove('active'));
        }

        async function showApp() {
            document.getElementById('auth').classList.remove('active');
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('userEmail').textContent = currentUser.email;
            showSection('home');
            await updateStats();
        }

        window.showSection = function(id) {
            document.querySelectorAll('section:not(#auth)').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'marketplace') loadProducts();
            if (id === 'home') updateStats();
        };

        async function updateStats() {
            const { data } = await supabase.from('products').select('*');
            if (data) {
                document.getElementById('totalProducts').textContent = data.length;
                document.getElementById('myProducts').textContent = data.filter(p => p.user_id === currentUser?.id).length || 0;
            }
        }

        async function uploadImage(file) {
            if (!file) return null;

            const extension = file.type?.split('/')[1] || 'jpg';
            const safeName = file.name ? file.name.replace(/[^a-zA-Z0-9.\-_]/g, '') : `image.${extension}`;
            const fileName = `${currentUser.id}_${Date.now()}_${safeName}`;

            const { error } = await supabase.storage.from('product-images').upload(fileName, file, {
                upsert: true,
                contentType: file.type || 'image/jpeg'
            });

            if (error) {
                console.error('Erreur upload:', error);
                showToast("‚ùå Erreur lors de l'upload de l'image");
                return null;
            }

            return supabase.storage.from('product-images').getPublicUrl(fileName).data.publicUrl;
        }

        document.getElementById('image').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = document.getElementById('cropperPreview');
                img.src = ev.target.result;
                img.style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    responsive: true,
                    autoCropArea: 1
                });
            };
            reader.readAsDataURL(file);
        });

        async function getCroppedBlob() {
            return new Promise(resolve => {
                if (!cropper) return resolve(null);
                cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => resolve(blob), 'image/jpeg', 0.9);
            });
        }

        // === LIKES (corrig√©) ===
        async function toggleLike(productId, button) {
            if (!currentUser) {
                showToast('Connecte-toi pour liker ‚ù§Ô∏è');
                return;
            }

            const { data: existing } = await supabase
                .from('product_likes')
                .select('id')
                .eq('product_id', productId)
                .eq('user_id', currentUser.id)
                .single();

            if (existing) {
                // Unlike
                await supabase.from('product_likes').delete().eq('id', existing.id);
                button.classList.remove('liked');
                const countSpan = button.querySelector('.like-count');
                countSpan.textContent = parseInt(countSpan.textContent) - 1;
            } else {
                // Like
                await supabase.from('product_likes').insert({ product_id: productId, user_id: currentUser.id });
                button.classList.add('liked');
                const countSpan = button.querySelector('.like-count');
                countSpan.textContent = parseInt(countSpan.textContent) + 1;
            }
        }

        async function getLikeInfo(productId) {
            const { count } = await supabase
                .from('product_likes')
                .select('*', { count: 'exact', head: true })
                .eq('product_id', productId);

            const { data: userLike } = await supabase
                .from('product_likes')
                .select('id')
                .eq('product_id', productId)
                .eq('user_id', currentUser?.id)
                .single();

            return { count: count || 0, liked: !!userLike };
        }

        // === AFFICHAGE PRODUITS ===
        async function loadProducts() {
            const container = document.getElementById('products');
            container.innerHTML = '<div class="spinner"></div>';
            const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
            container.innerHTML = '';
            if (error) {
                container.innerHTML = `<div class="empty-state"><h2>‚ùå Erreur</h2><p>${error.message}</p></div>`;
                return;
            }
            allProducts = data || [];
            filterAndDisplayProducts();
        }

        async function filterAndDisplayProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;
            let filtered = allProducts.filter(p => 
                p.title.toLowerCase().includes(searchTerm) || 
                (p.description && p.description.toLowerCase().includes(searchTerm)) ||
                p.contact.toLowerCase().includes(searchTerm)
            );

            if (sortBy === 'price-asc') filtered.sort((a, b) => a.price - b.price);
            else if (sortBy === 'price-desc') filtered.sort((a, b) => b.price - a.price);
            else filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const container = document.getElementById('products');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><h2>üîç Aucun r√©sultat</h2><p>Essaie une autre recherche ou sois le premier √† ajouter un produit !</p></div>';
                return;
            }

            for (const p of filtered) {
                const isOwner = p.user_id === currentUser?.id;
                const imageUrl = p.image || 'https://placehold.co/280x240/667eea/ffffff?text=Pas+d\'image';
                const { count: likes, liked } = await getLikeInfo(p.id);

                const div = document.createElement('div');
                div.className = 'product';
                div.innerHTML = `
                    ${isOwner ? '<div class="product-badge">üìå Mon produit</div>' : ''}
                    <img src="${imageUrl}" alt="${p.title}" onclick="showLightbox('${imageUrl}')">
                    <div class="product-info">
                        <h3>${p.title}</h3>
                        ${p.description ? `<p class="product-description">${p.description}</p>` : ''}
                        <p style="font-size:1.4em;color:#667eea;font-weight:bold;margin:12px 0;">${p.price} ‚Ç¨</p>
                        <p>üì± ${p.contact}</p>

                        <div style="margin:18px 0;">
                            <button class="like-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${p.id}', this)">
                                ‚ù§Ô∏è <span class="like-count">${likes}</span>
                            </button>
                        </div>

                        ${isOwner ? `
                        <div class="product-actions">
                            <button onclick="editProduct('${p.id}')" class="secondary">‚úèÔ∏è Modifier</button>
                            <button onclick="deleteProduct('${p.id}')" class="danger">üóëÔ∏è Supprimer</button>
                        </div>` : ''}
                    </div>`;
                container.appendChild(div);
            }
        }

        document.getElementById('searchInput').addEventListener('input', filterAndDisplayProducts);
        document.getElementById('sortSelect').addEventListener('change', filterAndDisplayProducts);

        // === COMPTEUR CARACT√àRES DESCRIPTION ===
        const descriptionInput = document.getElementById('description');
        const charCounter = document.getElementById('charCounter');
        descriptionInput.addEventListener('input', () => {
            const length = descriptionInput.value.length;
            charCounter.textContent = `${length} / 90`;
            if (length > 90) {
                charCounter.classList.add('warning');
            } else {
                charCounter.classList.remove('warning');
            }
        });

        // === AJOUT / MODIFICATION PRODUIT ===
        document.getElementById('productForm').addEventListener('submit', async e => {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const contact = document.getElementById('contact').value.trim();
            const editId = document.getElementById('editId').value;
            const btn = document.getElementById('submitBtn');

            if (!title || !contact || price <= 0) {
                showToast('‚ùå Titre, contact et prix sont obligatoires');
                return;
            }

            btn.disabled = true;
            btn.textContent = editId ? 'Modification...' : 'Ajout...';

            let imageUrl = null;
            if (document.getElementById('image').files.length > 0 && cropper) {
                const croppedBlob = await getCroppedBlob();
                if (croppedBlob) imageUrl = await uploadImage(croppedBlob);
            }

            const productData = {
                title,
                description: description || null,
                price,
                contact,
                user_id: currentUser.id
            };
            if (imageUrl) productData.image = imageUrl;

            let result;
            if (editId) {
                result = await supabase.from('products').update(productData).eq('id', editId).eq('user_id', currentUser.id);
            } else {
                result = await supabase.from('products').insert([productData]);
            }

            btn.disabled = false;
            btn.textContent = editId ? 'Modifier le produit' : 'Ajouter le produit';

            if (result.error) {
                console.error('Erreur Supabase:', result.error);
                showToast('‚ùå Erreur : ' + result.error.message);
            } else {
                showToast(editId ? '‚úÖ Produit modifi√© !' : '‚úÖ Produit ajout√© !');
                document.getElementById('productForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('submitBtn').textContent = 'Ajouter le produit';
                document.getElementById('cropperPreview').style.display = 'none';
                charCounter.textContent = '0 / 500';
                if (cropper) { cropper.destroy(); cropper = null; }
                showSection('marketplace');
            }
        });

        window.editProduct = async function(id) {
            const { data, error } = await supabase.from('products').select('*').eq('id', id).single();
            if (error || !data || data.user_id !== currentUser.id) {
                showToast('‚ùå Impossible de modifier ce produit');
                return;
            }
            document.getElementById('title').value = data.title;
            document.getElementById('description').value = data.description || '';
            charCounter.textContent = `${data.description ? data.description.length : 0} / 500`;
            document.getElementById('price').value = data.price;
            document.getElementById('contact').value = data.contact;
            document.getElementById('editId').value = data.id;
            document.getElementById('submitBtn').textContent = 'Modifier le produit';
            document.getElementById('cancelBtn').style.display = 'block';

            if (data.image) {
                const img = document.getElementById('cropperPreview');
                img.src = data.image;
                img.style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, responsive: true, autoCropArea: 1 });
            } else {
                document.getElementById('cropperPreview').style.display = 'none';
                if (cropper) { cropper.destroy(); cropper = null; }
            }
            showSection('add-product');
        };

        window.deleteProduct = async function(id) {
            if (!confirm('Supprimer ce produit d√©finitivement ?')) return;
            const { error } = await supabase.from('products').delete().eq('id', id).eq('user_id', currentUser.id);
            if (error) {
                showToast('‚ùå Erreur lors de la suppression');
            } else {
                showToast('üóëÔ∏è Produit supprim√©');
                loadProducts();
            }
        };

        window.cancelEdit = function() {
            document.getElementById('productForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'Ajouter le produit';
            document.getElementById('cropperPreview').style.display = 'none';
            charCounter.textContent = '0 / 500';
            if (cropper) { cropper.destroy(); cropper = null; }
        };

        window.showLightbox = function(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        };

        window.hideLightbox = function() {
            document.getElementById('lightbox').style.display = 'none';
        };

        init();
    </script>
</body>
</html>